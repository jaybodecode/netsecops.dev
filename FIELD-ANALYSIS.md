# Field Analysis: LLM Generation vs. Pipeline Processing

**Date:** October 14, 2025  
**Status:** Analysis in Progress

---

## Problem Statement

The final article schema in `types/cyber.ts` requires fields that are missing from LLM-generated output. We need to determine:
1. Which fields should the LLM generate
2. Which fields should be added by post-processing pipeline scripts

---

## Field Categories

### ✅ Category 1: LLM Should Generate (Content Creation)
These are content fields that require AI understanding and writing:

- `headline` - LLM writes this ✅
- `title` - LLM writes this ✅
- `summary` - LLM writes this ✅
- `full_report` - LLM writes this ✅
- `twitter_post` - LLM generates social content ✅
- `linkedin_post` - LLM generates social content ❌ **MISSING**
- `meta_description` - LLM generates SEO content ✅
- `og_description` - LLM should generate (similar to meta) ❌ **MISSING**
- `og_title` - LLM should generate (similar to headline) ❌ **MISSING**
- `featured_image_alt` - LLM should describe image needs ❌ **MISSING**
- `keywords` - LLM extracts/generates SEO keywords ⚠️ **OPTIONAL**
- `threat_type` - LLM classifies threat ❌ **MISSING**
- `confidence` - LLM assesses confidence level ❌ **MISSING**
- `affected_industries` - LLM extracts from content ❌ **MISSING**
- `affected_regions` - LLM extracts from content ❌ **MISSING**
- `geographic_scope` - LLM determines scope ❌ **MISSING**

### 🔧 Category 2: Pipeline Should Generate (System/Technical)
These are system-generated or computed fields:

- `id` - Generated by system (UUID)
- `slug` - Generated from title
- `featured_image_url` - Generated by image service (placeholder initially)
- `og_image` - Copy of featured_image_url (set after image generation)
- `twitter_image` - Copy of featured_image_url (set after image generation)
- `twitter_card_type` - Computed based on image availability
- `reading_time_minutes` - Computed from word count
- `extract_datetime` - System timestamp
- `updateCount` - Tracked by system (0 for new articles)
- `isUpdate` - Computed from updateCount
- `created_at` - Database timestamp
- `updated_at` - Database timestamp
- `publication_date` - Set by pipeline scheduler

### 🤔 Category 3: Already Handled Correctly
These are in the current Zod schema:

- `category` ✅
- `severity` ✅
- `entities` ✅
- `cves` ✅
- `sources` ✅
- `events` ✅
- `mitre_techniques` ✅
- `tags` ✅
- `article_type` ✅
- `related_article_ids` ✅

---

## Missing Fields That LLM SHOULD Generate

### Critical Missing (LLM must generate):

1. **`linkedin_post`** 
   - Required by schema
   - Content field (AI writing needed)
   - Similar to twitter_post but longer format
   - **Action:** Add to Zod schema

2. **`og_description`**
   - Required by schema
   - SEO/social sharing content
   - Can be derived from meta_description or summary
   - **Action:** Add to Zod schema OR post-process from meta_description

3. **`og_title`**
   - Required by schema
   - SEO/social sharing content
   - Can be derived from headline
   - **Action:** Add to Zod schema OR post-process from headline

4. **`threat_type`**
   - Required by schema
   - Classification field requiring AI understanding
   - Examples: "Remote Code Execution", "Data Breach", "Ransomware Attack"
   - **Action:** Add to Zod schema

5. **`confidence`**
   - Required by schema
   - Assessment field: 'confirmed' | 'likely' | 'suspected' | 'rumored'
   - **Action:** Add to Zod schema

6. **`affected_industries`**
   - Required by schema
   - Extraction from article content
   - **Action:** Add to Zod schema

7. **`affected_regions`**
   - Required by schema
   - Extraction from article content
   - **Action:** Add to Zod schema

8. **`geographic_scope`**
   - Required by schema
   - Classification: 'local' | 'regional' | 'national' | 'global'
   - **Action:** Add to Zod schema

9. **`featured_image_alt`**
   - Required by schema
   - Accessibility content (LLM should generate description)
   - **Action:** Add to Zod schema

10. **`keywords`**
    - Required by schema (currently optional in Zod)
    - SEO field
    - **Action:** Make required in Zod schema

### Fields That Should Be Post-Processed:

1. **`featured_image_url`**
   - Set to placeholder by LLM: "/images/cyber-placeholder.jpg"
   - Updated later by image generation pipeline
   - **Action:** Already handled, keep as-is

2. **`og_image`**
   - Should copy `featured_image_url` value
   - **Action:** Add post-processing step to copy featured_image_url → og_image

3. **`twitter_image`**
   - Should copy `featured_image_url` value
   - **Action:** Add post-processing step to copy featured_image_url → twitter_image

4. **`twitter_card_type`**
   - Should be 'summary_large_image' if featured_image exists
   - Should be 'summary' if no image
   - **Action:** Add post-processing step OR add simple logic to Zod schema

5. **`updateCount`**
   - Should be 0 for all articles from generate-publication-unified.ts
   - Incremented by compare-articles-llm.ts for UPDATE decisions
   - **Action:** Set default value in Zod schema

6. **`isUpdate`**
   - Should be false for all new articles
   - Set to true by compare-articles-llm.ts for UPDATE decisions
   - **Action:** Set default value in Zod schema

---

## Recommended Solution

### Phase 1: Update Zod Schema (Step 2 - LLM Generation)
Add these fields for LLM to generate:
- ✅ `linkedin_post` (required)
- ✅ `og_description` (required) 
- ✅ `og_title` (required)
- ✅ `threat_type` (required)
- ✅ `confidence` (required)
- ✅ `affected_industries` (required)
- ✅ `affected_regions` (required)
- ✅ `geographic_scope` (required)
- ✅ `featured_image_alt` (required)
- ✅ `keywords` (make required, not optional)
- ✅ `updateCount` (default: 0)
- ✅ `isUpdate` (default: false)

### Phase 2: Add Post-Processing Step (New Step 2.5?)
Create `enrich-article-metadata.ts` to run after Step 2:
- Copy `featured_image_url` → `og_image`
- Copy `featured_image_url` → `twitter_image`
- Set `twitter_card_type` based on image existence
- Validate all required fields are present

### Phase 3: Update Existing Steps
Update downstream scripts to handle new fields:
- `filter-articles-entity.ts` (Step 3) - pass through new fields
- `compare-articles-llm.ts` (Step 4) - preserve new fields
- `save-articles-with-entities.ts` (Step 5) - save new fields to DB
- `save-publication.ts` (Step 6) - include new fields in output

---

## Alternative Approach (Simpler)

Instead of a new pipeline step, handle post-processing in existing Step 3 or Step 5:

**Option A: Handle in Step 3 (filter-articles-entity.ts)**
- After entity classification, enrich metadata
- Copy image URLs, set twitter_card_type
- Validate required fields

**Option B: Handle in Step 5 (save-articles-with-entities.ts)**
- Before saving to database, enrich metadata
- Ensures all articles in DB have complete metadata
- Can use defaults for missing optional fields

---

## Next Steps

1. ✅ Revert hasty Zod schema changes
2. 🔄 Update Zod schema with ONLY fields LLM should generate
3. 🔄 Create or update pipeline script to enrich metadata
4. 🔄 Test with one article through full pipeline
5. 🔄 Update documentation

---

## Questions to Resolve

1. Should `og_description` be LLM-generated or copied from `meta_description`?
2. Should `og_title` be LLM-generated or copied from `headline`?
3. Where should post-processing happen? (Step 2.5, Step 3, or Step 5?)
4. Should we validate required fields at pipeline entry/exit points?
5. Are there other fields in `types/cyber.ts` we're missing?
