# Updates Schema Migration - Complete ‚úÖ

**Date:** October 14, 2025  
**Status:** Complete  
**Database:** `logs/content-generation-v2.db`

---

## ‚úÖ What Was Done

Added support for incremental article updates to the V3 database schema.

### Schema Changes

**1. Added columns to `articles` table:**
```sql
isUpdate INTEGER DEFAULT 0 CHECK(isUpdate IN (0, 1))
updateCount INTEGER DEFAULT 0
```

**2. Created `article_updates` table:**
```sql
CREATE TABLE article_updates (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  article_id TEXT NOT NULL,
  datetime TEXT NOT NULL,
  summary TEXT NOT NULL,
  content TEXT NOT NULL,
  severity_change TEXT CHECK(severity_change IN ('increased', 'decreased', 'unchanged')),
  created_at TEXT DEFAULT CURRENT_TIMESTAMP,
  FOREIGN KEY (article_id) REFERENCES articles(id) ON DELETE CASCADE
);
```

**3. Created `article_update_sources` table:**
```sql
CREATE TABLE article_update_sources (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  update_id INTEGER NOT NULL,
  article_id TEXT NOT NULL,
  url TEXT NOT NULL,
  title TEXT NOT NULL,
  website TEXT,
  date TEXT,
  FOREIGN KEY (update_id) REFERENCES article_updates(id) ON DELETE CASCADE,
  FOREIGN KEY (article_id) REFERENCES articles(id) ON DELETE CASCADE
);
```

---

## üìä Current Database State

```
Total Articles: 60
Articles with isUpdate=1: 0 (all currently new articles)
Article Updates: 0 (no updates yet)
```

---

## üéØ How Updates Work

### Data Flow

```
1. Duplicate Detection (check-duplicates.ts)
   ‚Üì
2. If SKIP-UPDATE ‚Üí Create article_update entry
   ‚Üì
3. Store in article_updates table with sources
   ‚Üì
4. Increment matched_article.updateCount
   ‚Üì
5. Set matched_article.isUpdate = 1
```

### Schema Design

**Original Article (in `articles` table):**
- `id`: "abc123"
- `headline`: "Clop Exploits Oracle EBS Zero-Day"
- `isUpdate`: 0 (original)
- `updateCount`: 3 (has 3 updates)
- `resolution`: 'NEW'

**Update 1 (in `article_updates` table):**
- `article_id`: "abc123"
- `datetime`: "2025-10-09T10:00:00Z"
- `summary`: "Exploit code released on GitHub"
- `content`: "Detailed info about exploit code..."
- `severity_change`: "increased"
- Sources in `article_update_sources`

**Update 2 (in `article_updates` table):**
- `article_id`: "abc123"
- `datetime`: "2025-10-10T14:30:00Z"
- `summary`: "Oracle releases emergency patch"
- `content`: "Oracle has released emergency patch..."
- `severity_change`: "decreased"
- Sources in `article_update_sources`

### Query Pattern

```sql
-- Get article with all updates
SELECT 
  a.*,
  json_group_array(
    json_object(
      'datetime', u.datetime,
      'summary', u.summary,
      'content', u.content,
      'severity_change', u.severity_change,
      'sources', (
        SELECT json_group_array(
          json_object(
            'url', s.url,
            'title', s.title,
            'website', s.website,
            'date', s.date
          )
        )
        FROM article_update_sources s
        WHERE s.update_id = u.id
      )
    )
  ) as updates
FROM articles a
LEFT JOIN article_updates u ON u.article_id = a.id
WHERE a.id = 'abc123'
GROUP BY a.id;
```

---

## üìù Next Steps

### 1. Update Duplicate Detection Logic

**File:** `check-duplicates.ts` or FTS5 implementation

When FTS5 detects a duplicate and LLM confirms it's an UPDATE:

```typescript
// Instead of just marking resolution='SKIP-UPDATE'
// Create an actual update entry:

const updateId = db.prepare(`
  INSERT INTO article_updates (article_id, datetime, summary, content, severity_change)
  VALUES (?, ?, ?, ?, ?)
`).run(
  matchedArticleId,
  newArticle.extract_datetime,
  updateSummary,  // Generated by LLM
  updateContent,  // Generated by LLM
  severityChange  // 'increased', 'decreased', 'unchanged'
).lastInsertRowid;

// Insert update sources
for (const source of newArticle.sources) {
  db.prepare(`
    INSERT INTO article_update_sources (update_id, article_id, url, title, website, date)
    VALUES (?, ?, ?, ?, ?, ?)
  `).run(updateId, matchedArticleId, source.url, source.title, source.root_url, source.source_date);
}

// Update the matched article
db.prepare(`
  UPDATE articles 
  SET updateCount = updateCount + 1,
      isUpdate = 1,
      updated_at = CURRENT_TIMESTAMP
  WHERE id = ?
`).run(matchedArticleId);
```

### 2. Update LLM Prompt for Updates

When calling LLM to compare duplicates, ask for:

```typescript
interface UpdateDecision {
  decision: 'NEW' | 'SKIP' | 'UPDATE';
  reasoning: string;
  
  // If decision === 'UPDATE', include:
  updateSummary?: string;        // 50-150 chars
  updateContent?: string;         // 200-800 chars
  severityChange?: 'increased' | 'decreased' | 'unchanged';
}
```

### 3. Update Article Output/RSS Generation

**Filter by resolution:**
```sql
-- Get NEW articles only (excludes duplicates)
SELECT * FROM articles WHERE resolution = 'NEW';

-- Get articles WITH updates (for display)
SELECT 
  a.*,
  (SELECT COUNT(*) FROM article_updates WHERE article_id = a.id) as update_count
FROM articles a
WHERE a.resolution = 'NEW'
ORDER BY a.created_at DESC;
```

**Include updates in output:**
```typescript
// When generating article detail pages or RSS
const article = getArticle(id);
const updates = db.prepare(`
  SELECT 
    u.*,
    json_group_array(
      json_object('url', s.url, 'title', s.title, 'website', s.website)
    ) as sources
  FROM article_updates u
  LEFT JOIN article_update_sources s ON s.update_id = u.id
  WHERE u.article_id = ?
  GROUP BY u.id
  ORDER BY u.datetime ASC
`).all(id);

// Output format:
// - Original article content
// - "Updates:" section
//   - Update 1 (with timestamp, content, sources)
//   - Update 2 (with timestamp, content, sources)
//   - etc.
```

### 4. Update Documentation

Update these files to reflect new schema:
- ‚úÖ `V3-DATABASE-SCHEMA.md` - Add updates tables
- ‚úÖ `HANDOVER_PROMPT.md` - Mention updates support
- `FTS5-SIMILARITY-STRATEGY.md` - Update flow diagram

---

## üîß Migration Script

**Created:** `scripts/content-generation-v2/add-updates-schema.ts`

**Usage:**
```bash
# Preview migration
npx tsx scripts/content-generation-v2/add-updates-schema.ts --dry-run

# Execute migration
npx tsx scripts/content-generation-v2/add-updates-schema.ts
```

**Idempotent:** Safe to run multiple times (checks existing schema first)

---

## ‚úÖ Verification

```bash
# Check columns exist
sqlite3 logs/content-generation-v2.db ".schema articles" | grep -E "isUpdate|updateCount"

# Check tables exist
sqlite3 logs/content-generation-v2.db ".tables" | grep update

# Check current state
sqlite3 logs/content-generation-v2.db "
SELECT 
  COUNT(*) as total_articles,
  SUM(isUpdate) as articles_with_updates,
  SUM(updateCount) as total_update_count,
  (SELECT COUNT(*) FROM article_updates) as update_entries
FROM articles"
```

Expected output (after migration, before implementation):
```
60|0|0|0
```

---

## üìö Related Files

- `scripts/content-generation/schemas/article.ts` - LLM schema (already has `ArticleUpdateSchema`)
- `types/cyber.ts` - TypeScript interface (needs `isUpdate`, `updateCount`, `updates` array)
- `check-duplicates.ts` - Needs update to create article_updates entries
- `insert-articles.ts` - Needs update to handle updates field
- Article output/RSS generation - Needs update to include updates

---

*Last Updated: October 14, 2025*  
*Migration Status: ‚úÖ Complete*  
*Ready for: Implementation in duplicate detection logic*
